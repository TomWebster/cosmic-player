---
phase: 02-canvas-scene-animation
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/scripts/canvasRenderer.js
  - src/scripts/sceneData.js
autonomous: false

must_haves:
  truths:
    - "Scene elements drift with slow parallax motion at visibly different layer speeds"
    - "Stars move slowest, moons move fastest, planet and sun are in between"
    - "Elements that drift off-screen reappear from the opposite edge seamlessly"
    - "Animation runs at smooth 60fps with no jank or stuttering"
    - "Animation speed is consistent regardless of display refresh rate (60Hz, 120Hz, 144Hz)"
  artifacts:
    - path: "src/scripts/canvasRenderer.js"
      provides: "Delta-time parallax animation loop"
      contains: "deltaTime"
    - path: "src/scripts/sceneData.js"
      provides: "Layer velocity configuration"
      contains: "depth"
  key_links:
    - from: "src/scripts/canvasRenderer.js"
      to: "requestAnimationFrame timestamp"
      via: "delta time calculation"
      pattern: "timestamp.*lastTimestamp|deltaTime"
    - from: "src/scripts/canvasRenderer.js"
      to: "src/scripts/sceneData.js"
      via: "layer depth multipliers for parallax speeds"
      pattern: "scene\\.layers.*depth"
---

<objective>
Add slow parallax animation to all scene elements so they drift at different speeds based on their layer depth, creating a sense of spatial depth and immersive motion.

Purpose: The parallax drift is what transforms a static image into a living cosmic scene. Different layer speeds create the illusion of depth — distant stars barely move while closer moons drift noticeably. This is the core visual mechanic of the experience.

Output: A smoothly animated cosmic scene with frame-rate independent parallax motion and seamless edge wrapping.
</objective>

<execution_context>
@/Users/tomw/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-canvas-scene-animation/02-RESEARCH.md
@.planning/phases/02-canvas-scene-animation/02-01-SUMMARY.md
@src/scripts/canvasRenderer.js
@src/scripts/sceneData.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add delta-time parallax animation with edge wrapping</name>
  <files>src/scripts/canvasRenderer.js, src/scripts/sceneData.js</files>
  <action>
Modify `canvasRenderer.js` to implement frame-rate independent parallax animation using the requestAnimationFrame timestamp parameter.

**1. Add timestamp tracking:**
Add a module-level variable `let lastTimestamp = 0;`.

**2. Update animate() signature and delta-time calculation:**
Change `animate()` to accept the rAF timestamp parameter:
```javascript
function animate(timestamp) {
  if (lastTimestamp === 0) {
    lastTimestamp = timestamp;
  }
  const deltaTime = (timestamp - lastTimestamp) / 1000; // seconds
  lastTimestamp = timestamp;

  updateScene(deltaTime);
  renderScene(ctx);

  animationId = requestAnimationFrame(animate);
}
```

**3. Create updateScene(deltaTime) function:**
This function moves all scene elements based on their layer depth and delta time. Use a slow base speed — the visual style references "slow ambient motion" from macOS screensavers. Start with `const BASE_SPEED = 15;` pixels per second (this is intentionally slow; the scene should feel like a very gradual drift, not a scroll).

Movement direction: All elements drift slowly to the LEFT (negative x). This creates the impression the viewer is slowly moving through space.

For each element type, calculate speed as `BASE_SPEED * layer.depth * deltaTime`:

```javascript
function updateScene(deltaTime) {
  if (!scene) return;

  const vw = window.innerWidth;
  const vh = window.innerHeight;

  // Stars drift (slowest)
  const starSpeed = BASE_SPEED * scene.layers.stars.depth * deltaTime;
  scene.stars.forEach(star => {
    star.x -= starSpeed;
    // Wrap: if star moves off left edge, reappear on right
    if (star.x < -5) {
      star.x = vw * 1.5 + Math.random() * 50;
      star.y = Math.random() * vh;
    }
  });

  // Sun drifts
  const sunSpeed = BASE_SPEED * scene.layers.sun.depth * deltaTime;
  scene.sun.x -= sunSpeed;
  if (scene.sun.x < -scene.sun.radius * 2) {
    scene.sun.x = vw + scene.sun.radius * 2;
  }

  // Planet drifts (midground)
  const planetSpeed = BASE_SPEED * scene.layers.planet.depth * deltaTime;
  scene.planet.x -= planetSpeed;
  if (scene.planet.x < -scene.planet.radius * 2) {
    scene.planet.x = vw + scene.planet.radius * 2;
  }

  // Moons drift (fastest — foreground)
  const moonSpeed = BASE_SPEED * scene.layers.moons.depth * deltaTime;
  scene.moons.forEach(moon => {
    moon.x -= moonSpeed;
    if (moon.x < -moon.radius * 2) {
      moon.x = vw + moon.radius * 2;
    }
  });
}
```

**4. Handle edge wrapping carefully:**
- Stars: When x goes below -5 (slightly off-screen left), reset to right side at `vw * 1.5` plus a small random offset (avoids all stars reappearing at exact same x). Randomize y position for variety.
- Planet/Sun/Moons: When center goes beyond -radius*2 off-screen left, reset to vw + radius*2 on the right. This ensures the full body has exited before wrapping.

**5. Add very subtle vertical drift:**
To avoid the scene feeling like a flat conveyor belt, add a tiny sinusoidal vertical oscillation to the planet and moons. Use a module-level `let elapsedTime = 0;` accumulator. In updateScene: `elapsedTime += deltaTime;`. Apply a small sine offset to y in renderScene (not to the data — keep y in data stable, apply offset only during render):

In renderScene, when drawing the planet:
```javascript
const planetYOffset = Math.sin(elapsedTime * 0.3) * 5; // 5px amplitude, very slow
```
Apply similar to moons with slightly different frequency (e.g., `elapsedTime * 0.4` and `elapsedTime * 0.5` for the two moons).

Do NOT apply vertical drift to stars or sun — stars should just drift horizontally, sun is too distant for visible vertical motion.

**6. Fix the initial requestAnimationFrame call:**
The first call to `requestAnimationFrame(animate)` in `initCanvas()` (or wherever it currently is) needs no changes — rAF automatically passes the timestamp as the first argument.

**7. Guard against large delta spikes:**
If the tab was backgrounded and then foregrounded, deltaTime could be very large (seconds). Clamp it: `const deltaTime = Math.min((timestamp - lastTimestamp) / 1000, 0.1);` — cap at 100ms to prevent elements teleporting.

**8. Update sceneData.js if needed:**
If the `layers` object from Plan 01 doesn't have all four layer entries (stars, sun, planet, moons), add them now. Verify the depth values create visible speed differences: stars 0.2, sun 0.3, planet 0.5, moons 0.8.
  </action>
  <verify>
Open in browser. All scene elements should be slowly drifting to the left at visibly different speeds. Stars should move very slowly, planet at medium speed, moons noticeably faster. When elements reach the left edge, they should reappear from the right without any visible pop-in. Planet and moons should have a very subtle vertical oscillation. No jank or stuttering visible. Open Chrome DevTools Performance tab, record 5 seconds of animation — frame times should be consistently under 16.67ms (60fps target).
  </verify>
  <done>All scene elements animate with frame-rate independent parallax drift at different layer speeds. Edge wrapping is seamless. Delta time prevents speed variation across different refresh rates. Frame rate maintains 60fps.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual quality and performance verification</name>
  <files>src/scripts/canvasRenderer.js</files>
  <action>
Human verification checkpoint. All automated work is complete — this task verifies visual quality and performance of the animated cosmic scene.

What was built:
- Sparse bright starfield drifting slowly across the background
- A Saturn-colored planet with 3D gradient shading drifting through the midground
- Two subtle khaki moons drifting in the foreground (fastest)
- A distant sun with radial glow
- All elements parallax-drifting at different speeds with seamless edge wrapping
- Subtle vertical oscillation on planet and moons

How to verify:
1. Open the app in browser (likely `index.html` served locally or via file://)
2. Click the splash screen to enter
3. Observe the cosmic scene for 30+ seconds:
   - Stars should drift very slowly to the left
   - Planet should drift at a moderate pace
   - Moons should drift noticeably faster than the planet
   - Sun should drift slowly
   - The speed differences should create a clear sense of depth
4. Watch for edge wrapping — when an element exits the left edge, it should reappear from the right without any visible jump or flash
5. The overall motion should feel ambient and calm — like a screensaver, not a game
6. Check visual quality:
   - Planet should have a 3D sphere appearance (gradient shading)
   - Stars should vary in size and brightness
   - Moons should be subtle, not visually dominant
   - Sun should have a soft glow
7. Resize the browser window — scene should adapt (elements may regenerate, which is acceptable)
8. Check for smooth performance — no stuttering, dropped frames, or jank

Resume signal: Type "approved" if the scene looks good, or describe any visual or performance issues to address.
  </action>
  <verify>User confirms visual quality and performance are acceptable.</verify>
  <done>User has approved the animated cosmic scene's visual quality, parallax depth effect, and performance.</done>
</task>

</tasks>

<verification>
- Animation runs smoothly at 60fps (check Chrome DevTools Performance panel)
- Parallax layers move at visibly different speeds (stars slowest, moons fastest)
- Edge wrapping is seamless — no pop-in artifacts
- Scene feels ambient and immersive, not mechanical
- No JavaScript errors in console
- No memory leaks (check Chrome DevTools Memory — heap should be stable over minutes)
- Window resize handled correctly
</verification>

<success_criteria>
All cosmic scene elements animate with smooth parallax drift at different layer speeds. The animation is frame-rate independent, seamlessly wraps at edges, and maintains 60fps performance. The visual result feels like a calm, immersive cosmic screensaver — matching the project's core aesthetic of slow ambient motion.
</success_criteria>

<output>
After completion, create `.planning/phases/02-canvas-scene-animation/02-02-SUMMARY.md`
</output>
